// ===========================================================
// üåø Z√âNA - IA √âMOTIONNELLE QVT BOX (version enrichie 2025)
// ===========================================================

import "https://deno.land/x/xhr@0.1.0/mod.ts";
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// ===========================================================
// ‚öôÔ∏è CONFIGURATION
// ===========================================================

const corsHeaders = {
  "Access-Control-Allow-Origin": "https://zena.qvtbox.com",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

const supa = createClient(
  Deno.env.get("SUPABASE_URL")!,
  Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!
);

const OPENAI_API_KEY = Deno.env.get("OPENAI_API_KEY");
const EMB_MODEL = "text-embedding-3-small";
const OPENAI_CHAT = "gpt-4o-mini";

// ===========================================================
// üí¨ STRAT√âGIES RELATIONNELLES (Human Affect Model)
// ===========================================================
const AFFECT_STRATEGIES = [
  {
    label: "positive_engagement",
    description: "Reconnecter positivement √† sa situation ou √† ses √©motions.",
    examples: [
      "Je t‚Äô√©coute, raconte-moi ce qui s‚Äôest pass√©.",
      "Tu as d√©j√† surmont√© pire, tu peux le faire.",
      "On peut r√©fl√©chir ensemble √† une solution.",
      "Ce n‚Äôest pas si grave, tu vas t‚Äôen sortir.",
      "Je comprends ta col√®re, mais tu peux la canaliser diff√©remment.",
    ],
  },
  {
    label: "acceptance",
    description: "Valider, soutenir ou d√©tendre la relation.",
    examples: [
      "Je suis l√† pour toi, quoi qu‚Äôil arrive.",
      "Tu comptes beaucoup pour nous.",
      "√áa arrive √† tout le monde, ne t‚Äôen veux pas.",
      "Allez, on se prend un caf√© pour en parler ?",
      "Tu me fais sourire, m√™me dans les moments difficiles.",
    ],
  },
  {
    label: "negative_engagement",
    description: "Faire √©merger une prise de conscience difficile mais utile.",
    examples: [
      "Tu vois les cons√©quences de ton retard ?",
      "Franchement, tu pourrais faire un effort.",
      "Tu m‚Äôas vraiment d√©√ßu sur ce coup-l√†.",
      "Tu ne te rends pas compte du mal que tu fais.",
      "Je t‚Äôen parle parce que √ßa ne peut plus continuer comme √ßa.",
    ],
  },
  {
    label: "rejection",
    description: "Exprimer la distance ou le d√©sengagement.",
    examples: [
      "Je n‚Äôai pas envie d‚Äôen parler avec toi.",
      "Fais ce que tu veux, √ßa m‚Äôest √©gal.",
      "Tu exag√®res toujours.",
      "C‚Äôest ridicule de r√©agir comme √ßa.",
      "‚Ä¶ (silence ou absence de r√©ponse prolong√©e)",
    ],
  },
];

// ===========================================================
// üé≠ PERSONA SYSTEM
// ===========================================================
function personaSystem(p: "zena" | "zeno" = "zena", lang: "fr" | "en" = "fr") {
  const zenaFR = `Tu es Z√âNA, intelligence √©motionnelle de QVT Box.
Tu incarnes la bienveillance active : une pr√©sence douce et lucide.
Tu t‚Äôappuies sur les th√©ories de Karasek, Siegrist et les recherches OMS sur le bien-√™tre au travail.
Ton but : aider les personnes √† retrouver √©quilibre, sens et √©nergie.`;

  const zenoFR = `Tu es Z√âNO, coach analytique QVT.
Tu analyses calmement les causes du stress et aides √† agir avec m√©thode.`;

  return p === "zena" ? zenaFR : zenoFR;
}

// ===========================================================
// ‚ù§Ô∏è D√âTECTION D‚ÄôHUMEUR
// ===========================================================
function detectMood(t: string): "positive" | "neutral" | "negative" | "distress" {
  const s = t.toLowerCase();
  if (/(suicide|me faire du mal|plus envie|d√©tresse|detresse|d√©sespoir)/.test(s)) return "distress";
  if (/(stress|√©puis|epuis|burnout|angoisse|fatigu√©|fatigue|col√®re|triste)/.test(s)) return "negative";
  if (/(bien|motiv√©|motivation|heureux|content|confiant|serein)/.test(s)) return "positive";
  return "neutral";
}

// ===========================================================
// üß† ANALYSE √âMOTIONNELLE AVANC√âE (corrig√©e et robuste)
// ===========================================================
async function analyzeEmotion(text: string, lang: "fr" | "en") {
  if (!OPENAI_API_KEY) return null;

  const prompt =
    lang === "fr"
      ? `Tu es une IA √©motionnelle. Analyse le message suivant et renvoie un JSON strict avec :
{
  "emotion_dominante": "joie|calme|stress|tristesse|col√®re|fatigue|isolement",
  "intensit√©": 0-1,
  "besoin": "repos|reconnaissance|soutien|sens|lien",
  "ton_recommand√©": "rassurant|motivante|calme|doux|√©nergisant",
  "strat√©gie_relationnelle": "positive_engagement|acceptance|negative_engagement|rejection"
}
Message : """${text}"""
R√©ponds uniquement en JSON, sans explication ni texte suppl√©mentaire.`
      : `Analyze the message below and respond ONLY with valid JSON:
{
  "dominant_emotion": "joy|calm|stress|sadness|anger|fatigue|isolation",
  "intensity": 0-1,
  "underlying_need": "rest|recognition|support|meaning|connection",
  "tone_hint": "reassuring|motivating|calm|gentle|energizing",
  "relational_strategy": "positive_engagement|acceptance|negative_engagement|rejection"
}
Message: """${text}"""`;

  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${OPENAI_API_KEY}`,
    },
    body: JSON.stringify({
      model: OPENAI_CHAT,
      messages: [{ role: "user", content: prompt }],
      temperature: 0.2,
      response_format: { type: "json_object" }, // ‚úÖ force OpenAI √† renvoyer du JSON
    }),
  });

  const j = await res.json();
  console.log("[ZENA] Raw OpenAI response:", j);

  try {
    const parsed = j.choices?.[0]?.message?.content
      ? JSON.parse(j.choices[0].message.content)
      : j;
    console.log("[ZENA] ‚úÖ Emotion parsed:", parsed);
    return parsed;
  } catch (err) {
    console.error("[ZENA] ‚ùå Failed to parse emotion JSON:", err);
    return {
      emotion_dominante: "inconnue",
      intensit√©: 0.0,
      besoin: "non d√©fini",
      ton_recommand√©: "rassurant",
    };
  }
}

// ===========================================================
// üí¨ OPENAI CHAT
// ===========================================================
async function callOpenAI(messages: any[]) {
  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: { "Content-Type": "application/json", Authorization: `Bearer ${OPENAI_API_KEY}` },
    body: JSON.stringify({ model: OPENAI_CHAT, messages, temperature: 0.7 }),
  });
  const j = await res.json();
  return j.choices?.[0]?.message?.content?.trim() ?? "";
}

// ===========================================================
// ‚úÖ HANDLER PRINCIPAL ‚Äî VERSION CORS ULTRA-STABLE
// ===========================================================
serve(async (req) => {
  // --- OPTIONS (CORS preflight)
  if (req.method === "OPTIONS") {
    return new Response("ok", {
      status: 200,
      headers: {
        "Access-Control-Allow-Origin": "https://zena.qvtbox.com",
        "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
        "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
        "Access-Control-Max-Age": "86400",
      },
    });
  }

  try {
    const { text, persona = "zena", lang = "fr" } = await req.json();

    if (!text?.trim()) {
      return new Response(JSON.stringify({ error: "missing text" }), {
        status: 400,
        headers: {
          "Access-Control-Allow-Origin": "https://zena.qvtbox.com",
          "Content-Type": "application/json",
        },
      });
    }

    // --- IA principale
    const mood = detectMood(text);
    const emotional = await analyzeEmotion(text, lang);
    const system = personaSystem(persona, lang);

    const intro = "Je t‚Äô√©coute, raconte-moi ce que tu ressens.";
    const messages = [
      { role: "system", content: system },
      {
        role: "user",
        content: `Message : ${text}
√âmotion : ${emotional?.emotion_dominante || mood}
Besoin : ${emotional?.besoin || "inconnu"}
Adopte un ton ${emotional?.ton_recommand√© || "calme"}.
Commence par une phrase comme : "${intro}"`,
      },
    ];

    const reply = await callOpenAI(messages);

    return new Response(
      JSON.stringify({ reply, mood, emotional }),
      {
        status: 200,
        headers: {
          "Access-Control-Allow-Origin": "https://zena.qvtbox.com",
          "Content-Type": "application/json",
        },
      }
    );
  } catch (err) {
    console.error("[qvt-ai] Fatal error:", err);

    return new Response(
      JSON.stringify({
        error: err?.message || "Unknown error",
        fix: "Check API keys or function logs.",
      }),
      {
        status: 200, // ‚ö†Ô∏è pour √©viter blocage CORS
        headers: {
          "Access-Control-Allow-Origin": "https://zena.qvtbox.com",
          "Content-Type": "application/json",
        },
      }
    );
  }
});
